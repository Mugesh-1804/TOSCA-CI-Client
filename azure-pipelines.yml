trigger: none  # Manual trigger only

parameters:
  - name: testCaseName
    type: string
    default: 'Deals_CanadaDen_EligibleSalesOrg_BuyX_GetX'

  - name: testEvent
    type: string
    default: 'Deals_CanadaDen_EligibleSalesOrg_BuyX_GetX'

pool:
  name: 'TOSCA CI'

variables:
  toscaServerUrl: 'https://tosca.corp.pattersoncompanies.com'
  projectName: 'Tosca_PattersonAutomation'
  clientId: '-4m_zGxoBESTvMw7zvlmjg'
  clientSecret: '$(toscaClientSecret)'  # from Library

steps:

# Step 1: Run Tosca test via your PowerShell script
- task: PowerShell@2
  displayName: 'Run Tosca Test Event'
  inputs:
    targetType: 'filePath'
    filePath: 'C:\\tmp\\ExecutionClients\\tosca_execution_clientNew.ps1'
    arguments: >
      -toscaServerUrl "$(toscaServerUrl)"
      -events '["$(testEvent)"]'
      -projectName "$(projectName)"
      -clientId "$(clientId)"
      -clientSecret "$(clientSecret)"
      -testCaseName "$(testCaseName)"

# Step 2: Always generate the UNC report path and log it
- task: PowerShell@2
  displayName: 'Generate Tosca Report Path'
  condition: always()
  inputs:
    targetType: 'inline'
    script: |
      $testCase = "$env:testCaseName"
      $build = $env:BUILD_BUILDNUMBER
      $uncPath = "\\\\tosca.corp.pattersoncompanies.com\\sap_automation_test_evidence\\Projects\\JenkinsTestCases\\Deals\\$testCase\\${testCase}-$build.html"

      Write-Host "`n======================================="
      Write-Host " Tosca Report Path (Always Shown):"
      Write-Host " $uncPath"
      Write-Host "=======================================`n"

      $markdown = "[Open Tosca Report]($uncPath)"
      Set-Content -Path "$(Build.ArtifactStagingDirectory)\ToscaReport.md" -Value $markdown

# Step 3: Publish the Markdown file as a pipeline artifact
- task: PublishPipelineArtifact@1
  displayName: 'Publish Tosca Report Link'
  condition: always()
  inputs:
    targetPath: '$(Build.ArtifactStagingDirectory)\ToscaReport.md'
    artifact: 'ToscaReportMarkdown'

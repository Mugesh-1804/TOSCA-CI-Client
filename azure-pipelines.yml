trigger: none  # Manual trigger only

# Step 1: Accept user input at runtime

# Step 2: Map parameters to variables for runtime use
variables:
  toscaServerUrl: 'https://tosca.corp.pattersoncompanies.com'
  projectName: 'Tosca_PattersonAutomation'
  clientId: '-4m_zGxoBESTvMw7zvlmjg'
  clientSecret: '8t2ryHp3JkOVrc5837s0AwNVduR3u-AEOV9hY3xU2cfQ'  # From variable group (secret)

# Step 3: Use a self-hosted Tosca agent pool
pool:
  name: 'TOSCA CI'

steps:

# Step 4: Run the Tosca test
- task: PowerShell@2
  displayName: 'Run Tosca Test Event'
  timeoutInMinutes: 240
  inputs:
    targetType: 'filePath'
    filePath: 'C:\\tmp\\ExecutionClients\\tosca_execution_clientNew.ps1'
    arguments: >
      -toscaServerUrl "$(toscaServerUrl)"
      -events '["$(testEventName)"]'
      -projectName "$(projectName)"
      -clientId "$(clientId)"
      -clientSecret "$(clientSecret)"
      -testCaseName "$(testCaseName)"

# Step 5: Rename Tosca report with build number
- task: PowerShell@2
  displayName: 'Copy and Rename Tosca Report with Build Number'
  condition: always()
  inputs:
    targetType: 'inline'
    script: |
     # Read variables from Azure DevOps
$User = "$(shareUsername)"
$PlainPassword = "$(sharePassword)"

# Convert password to secure string
$SecurePassword = ConvertTo-SecureString $PlainPassword -AsPlainText -Force
$Credential = New-Object System.Management.Automation.PSCredential ($User, $SecurePassword)

# Optional: Map the network drive
$NetworkPath = "\\tosca.corp.pattersoncompanies.com\sap_automation_test_evidence"
$DriveLetter = "Z:"

New-PSDrive -Name "Z" -PSProvider FileSystem -Root $NetworkPath -Credential $Credential -Persist

# Perform the file copy
$sourcePath = "C:\Path\To\Your\ToscaReport.html"
$buildNumber = "$(Build.BuildNumber)"
$targetPath = "Z:\Projects\JenkinsTestCases\Deals\Deals_CanadaDen_EligibleSalesOrg_BuyX_GetX-$buildNumber.html"

Copy-Item -Path $sourcePath -Destination $targetPath -Force

# Clean up
Remove-PSDrive -Name "Z"

      if (Test-Path $sourcePath) {
          Copy-Item -Path $sourcePath -Destination $targetPath -Force
          Write-Host "✅ Report copied to: $targetPath"
      } else {
          Write-Host "⚠️ Report not found at: $sourcePath"
      }

# Step 6: Generate UNC report link and save as Markdown
- task: PowerShell@2
  displayName: 'Generate Tosca Report Path'
  condition: always()
  inputs:
    targetType: 'inline'
    script: |
      $testCase = "$env:testCaseName"
      $build = $env:BUILD_BUILDNUMBER
      $uncPath = "\\tosca.corp.pattersoncompanies.com\sap_automation_test_evidence\Projects\JenkinsTestCases\Deals\$testCase\$testCase-$buildNumber.html"

      Write-Host "`n======================================="
      Write-Host " Tosca Report Path (Always Shown):"
      Write-Host " $uncPath"
      Write-Host "=======================================`n"

      $markdown = "[Open Tosca Report]($uncPath)"
      Set-Content -Path "$(Build.ArtifactStagingDirectory)\ToscaReport.md" -Value $markdown

# Step 7: Publish the Markdown file as a pipeline artifact
- task: PublishPipelineArtifact@1
  displayName: 'Publish Tosca Report Link'
  condition: always()
  inputs:
    targetPath: '$(Build.ArtifactStagingDirectory)\ToscaReport.md'
    artifact: 'ToscaReportMarkdown'
